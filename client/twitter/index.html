<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="/fonts/stylesheet.css" rel="stylesheet">        
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">        
        <style>
            body {
                font-family: "Roboto Mono";
                background: #222;
                color: white;
            }
            h1 {
                font-family: "Retro Computer";
                font-size: 27px;
            }
            a {
                color: white;
            }
        </style>
        <script src="/js/jquery-3.7.1.min.js"></script>
        <script src="/js/ethers-5.2.umd.min.js" type="application/javascript"></script>
        <script>
            window.onload = () => {
                let twitterUserId;
                const cw3 = document.getElementById('connect-web3')
                const ct = document.getElementById('connect-twitter')
                const tl = document.getElementById('twitter-link')
                const resultDiv = document.getElementById('result')
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                console.log('urlParams', urlParams.get('code'))
                cw3.addEventListener('click', () => {
                    const provider = new ethers.providers.Web3Provider(window.ethereum)
                    provider.send("eth_requestAccounts", []).then(account => {
                        const signer = provider.getSigner()
                        const signature = signer.signMessage(`This signature is safe and will bind your wallet to your DAO user ID.`).then(signature => {
                            console.log(`account: ${account} signature: ${signature}`)
                            sendSignature(account[0], signature, twitterUserId)
                        });
                    })
                })

                if (!urlParams.has('code')) {
                    ct.style.display = 'none'
                    tl.style.display = 'block'
                    fetch('/dao/bind/twitter/url', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }).then(result => {
                        result.json().then(response => {
                            console.log(response)
                            tl.innerHTML = `<a href="${response.url}">Click here to connect your twitter account</a>`
                        })
                    })
                } else {
                    fetch('/dao/bind/twitter', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            code: urlParams.get('code'),
                            state: urlParams.get('state')
                        })
                    }).then(result => {
                        result.json().then(response => {
                            console.log(response)
                            if (response.result === 'ok') {
                                ct.innerHTML = `Twitter account:  ${response.twitterUsername}`
                                if (response.hasOwnProperty('discordUserId')) {
                                    resultDiv.innerHTML = 'Your web3 wallet is now tied to your twitter account, you can safely close this window.'
                                } else {
                                    twitterUserId = response.twitterId
                                    cw3.style.display = 'block'
                                }
                            } else {
                                ct.style.display = 'none'
                                resultDiv.innerHTML = 'An error occured, please refresh this page and retry.'
                            }
                            resultDiv.style.display = 'block'
                        })
                    })
                }


                function sendSignature(account, signature, twitterUserId) {
                    const cw3 = document.getElementById('connect-web3')
                    const resultDiv = document.getElementById('result')

                    fetch('/dao/bind/web3', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            account,
                            signature,
                            twitterUserId,
                            twitterCode: urlParams.get('code'),
                            twitterState: urlParams.get('state')                        
                        })
                    }).then(result => {
                        result.json().then(response => {
                            console.log(response)
                            cw3.style.display = 'none'
                            if (response.result === 'ok') {
                                resultDiv.innerHTML = 'Your web3 wallet is now tied to your discord account, you can safely close this window.'
                            } else {
                                resultDiv.innerHTML = 'An error occured, please refresh this page and retry.'
                            }
                            resultDiv.style.display = 'block'
                        })
                    })
                }                
            }
        </script>
    </head>
    <body>
        <h1>Cryptophunk Discord / Twitter account binder</h1>
        
        <div id="twitter-link" style="display: none;">Connecting...</div>

        <div id="connect-twitter">Connecting...</div>
        
        <a id="connect-web3" style="margin-top: 10px; display:none;" href="#">Connect Web3 Wallet</a>

        <div id="result" style="margin-top: 10px; display:none;"></div>
    </body>
</html>
